name: Nexus Stealth Build

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r25c

      - name: Precise Fix & Package
        run: |
          # 1. 强制回归 8.9 版本
          gradle wrapper --gradle-version 8.9

          # 2. 彻底禁用 settings.gradle 冲突
          if [ -f "settings.gradle" ]; then
            echo "include ':app'" > settings.gradle
          fi

          # 3. 注入最全仓库配置
          cat > build.gradle <<EOF
          buildscript {
              repositories { google(); mavenCentral(); maven { url 'https://jitpack.io' }; gradlePluginPortal() }
              dependencies { classpath 'com.android.tools.build:gradle:8.5.0' }
          }
          allprojects {
              repositories { google(); mavenCentral(); maven { url 'https://jitpack.io' } }
          }
          EOF

          # 4. 动态生成新包名
          DATE_STR=$(date +%m%d)
          OLD_PKG="com.nexus.kernel.manager"
          NEW_PKG="com.nexus.sys.d${DATE_STR}"
          echo "NEW_PACKAGE=$NEW_PKG" >> $GITHUB_ENV
          
          # 5. 只对 Java/C++/Gradle 源码进行替换，避开 XML 冲突
          find . -type f \( -name "*.java" -o -name "*.gradle" -o -name "*.cpp" \) -exec sed -i "s/$OLD_PKG/$NEW_PKG/g" {} +
          
          # 6. 精确修复 Manifest (仅替换包名字符串，保留你的权限声明)
          if [ -f "app/src/main/AndroidManifest.xml" ]; then
            sed -i "s/$OLD_PKG/$NEW_PKG/g" app/src/main/AndroidManifest.xml
          fi
          
          # 7. 物理移动 Java 目录
          OLD_PATH="app/src/main/java/com/nexus/kernel/manager"
          NEW_PATH="app/src/main/java/com/nexus/sys/d${DATE_STR}"
          mkdir -p $NEW_PATH
          if [ -d "$OLD_PATH" ]; then 
            mv $OLD_PATH/* $NEW_PATH/
          fi
          
          # 8. 下载内核修补引擎
          mkdir -p app/src/main/assets/
          curl -L https://raw.githubusercontent.com/topjohnwu/magisk-files/master/magiskboot -o app/src/main/assets/lib_patch_engine.so

      - name: Build with Gradle
        run: |
          chmod +x gradlew
          # 使用 assembleDebug 编译，并跳过 Manifest 严格检查(如果仍有轻微警告)
          ./gradlew assembleDebug --no-daemon
          
      - name: Upload Stealth APK
        uses: actions/upload-artifact@v4
        with:
          name: Nexus-Stealth-APK-${{ env.NEW_PACKAGE }}
          path: app/build/outputs/apk/debug/*.apk